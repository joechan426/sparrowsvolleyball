<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Match Schedule</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background: #fff; color: #333; }
    header { background: #f8f8f8; padding: 20px; text-align: center; font-size: 1.5em; font-weight: bold; border-bottom: 1px solid #ddd; }
    .description { text-align: center; font-size: 1em; margin: 10px 0 20px; color: #666; }
    .filters { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px; }
    select, button { font-size: 1em; padding: 5px 10px; border: 1px solid #ccc; border-radius: 5px; }
    .match-card { border: 1px solid #ccc; border-radius: 10px; padding: 15px; margin: 10px; max-width: 500px; background: #fafafa; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .match-card strong { font-size: 1.2em; display: block; margin-bottom: 5px; color: #000; }
    .highlight { color: #007aff; font-weight: bold; }
    .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 1000; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); z-index: 999; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header>Match Schedule</header>
  <div class="description">Thank you so much for helping our league run smoothly</div>
  <div class="filters">
    <select id="teamFilter"><option value="">Select Team</option></select>
    <select id="divisionFilter"><option value="">Select Division</option></select>
    <select id="courtFilter"><option value="">Select Court</option></select>
    <select id="dateFilter"><option value="">Select Date</option></select>
    <button onclick="resetFilters()">Reset</button>
  </div>
  <div id="results"></div>
  <div id="popupContainer" class="hidden"></div>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzcph6-6MiJU7v_XKcM6BHi80WOX4QE-Un9QCDIWL8E-Ii2X62-DvcyXkDRnN1T8O8/exec';
    let matchData = {};
    let defaultDate = '';

    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        defaultDate = data._defaultDate;
        delete data._defaultDate;
        matchData = data;
        populateFilters();
        renderResults();
      });

    function populateFilters() {
      const teamSet = new Set(), divisionSet = new Set(), courtSet = new Set(), dateSet = [];
      for (let date in matchData) {
        dateSet.push(date);
        matchData[date].forEach(match => {
          teamSet.add(match.team);
          teamSet.add(match.opponent);
          divisionSet.add(match.division);
          courtSet.add(match.location);
        });
      }
      populateSelect('teamFilter', [...teamSet].sort());
      populateSelect('divisionFilter', [...divisionSet].sort());
      populateSelect('courtFilter', [...courtSet].sort());
      populateSelect('dateFilter', dateSet);
      document.getElementById('dateFilter').value = defaultDate;
    }

    function populateSelect(id, items) {
      const select = document.getElementById(id);
      items.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
      });
    }

    function resetFilters() {
      document.getElementById('teamFilter').value = '';
      document.getElementById('divisionFilter').value = '';
      document.getElementById('courtFilter').value = '';
      document.getElementById('dateFilter').value = defaultDate;
      renderResults();
    }

    document.querySelectorAll('select').forEach(el => {
      el.addEventListener('change', renderResults);
    });

    function renderResults() {
      const team = document.getElementById('teamFilter').value;
      const division = document.getElementById('divisionFilter').value;
      const court = document.getElementById('courtFilter').value;
      const date = document.getElementById('dateFilter').value;
      const container = document.getElementById('results');
      container.innerHTML = '';

      if (!matchData[date]) return;

      matchData[date].forEach((match, idx) => {
        if (team && team !== match.team && team !== match.opponent) return;
        if (division && division !== match.division) return;
        if (court && court !== match.location) return;

        const card = document.createElement('div');
        card.className = 'match-card';
        card.innerHTML = `
          <strong>${match.team} <span class="highlight">vs</span> ${match.opponent}</strong>
          Time: ${match.time}<br>
          Court: ${match.location}<br>
          Duty: ${match.dutyTeam}<br>
        `;

        if (match.allowSubmit) {
          const btn = document.createElement('button');
          btn.textContent = 'Enter Result (Referee use only)';
          btn.style.background = '#007aff';
          btn.style.color = 'white';
          btn.style.marginTop = '10px';
          btn.style.border = 'none';
          btn.style.padding = '8px 12px';
          btn.style.borderRadius = '8px';
          btn.onclick = () => enterPasscodePrompt(date, idx, match);
          card.appendChild(btn);
        }

        container.appendChild(card);
      });
    }

    function enterPasscodePrompt(date, index, match) {
      const code = prompt('Enter referee passcode');
      if (!code) return;
      fetch(`${API_URL}?action=validate&date=${encodeURIComponent(date)}&index=${index}&passcode=${code}`)
        .then(r => r.text())
        .then(result => {
          if (result === 'PASS_OK') showScorePopup(date, index, match);
          else alert('Passcode Error');
        });
    }

    function showScorePopup(date, index, match) {
      const overlay = document.createElement('div');
      overlay.className = 'overlay';
      const popup = document.createElement('div');
      popup.className = 'popup';

      popup.innerHTML = `
        <div style="text-align:center; font-weight:bold; margin-bottom:10px;">${match.team} vs ${match.opponent}</div>
        <table style="margin:auto; text-align:center">
          <tr><th></th><th>${match.team}</th><th>${match.opponent}</th></tr>
          ${[1,2,3,4,5].map(i => `
            <tr>
              <td>${i} Set</td>
              <td><input type="number" id="s${i}_a" inputmode="numeric" style="width:50px"></td>
              <td><input type="number" id="s${i}_b" inputmode="numeric" style="width:50px"></td>
            </tr>`).join('')}
        </table>
        <div style="text-align:center; margin-top:10px;">
          <button id="submitScores">Submit</button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(popup);

      document.getElementById('submitScores').onclick = () => {
        const params = new URLSearchParams();
        params.append('action', 'submitScores');
        params.append('date', date);
        params.append('index', index);
        for (let i = 1; i <= 5; i++) {
          const a = document.getElementById(`s${i}_a`).value;
          const b = document.getElementById(`s${i}_b`).value;
          if (a) params.append(`s${i}_a`, a);
          if (b) params.append(`s${i}_b`, b);
        }
        fetch(`${API_URL}?${params.toString()}`)
          .then(r => r.text())
          .then(resp => {
            if (resp === 'SUCCESS') {
              overlay.remove();
              popup.remove();
              match.allowSubmit = false;
              renderResults();
            } else alert('Submission failed: ' + resp);
          });
      };
    }
  </script>
</body>
</html>
