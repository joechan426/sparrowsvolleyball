
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sparrows Volleyball Schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      margin: 0;
      padding: 20px;
      background: #fff;
      color: #333;
    }
    .header {
      text-align: center;
      font-size: 2em;
      margin-bottom: 0.3em;
    }
    .description {
      text-align: center;
      margin-bottom: 1.5em;
      font-style: italic;
      color: #777;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    select, button {
      font-size: 1em;
      padding: 0.4em;
    }
    .match-card {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px 15px;
      margin: 10px auto;
      max-width: 600px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .match-team {
      font-weight: bold;
      font-size: 1.3em;
      display: inline-block;
    }
    .match-vs {
      margin: 0 5px;
      color: #000;
    }
    .match-detail {
      font-size: 0.9em;
      margin-top: 5px;
      color: #555;
    }
    .score-btn {
      margin-top: 10px;
      padding: 0.4em 1em;
      background: #007aff;
      border: none;
      color: white;
      font-size: 0.95em;
      border-radius: 6px;
      cursor: pointer;
    }
    .score-btn:hover {
      background: #005ecb;
    }
    .popup {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 20px;
      z-index: 999;
      width: 90%;
      max-width: 420px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .popup input[type="number"],
    .popup input[type="text"] {
      width: 100%;
      padding: 0.4em;
      margin-bottom: 10px;
      font-size: 1em;
    }
    .popup label {
      font-weight: bold;
    }
    .team-color {
      display: inline-block;
      padding: 0.2em 0.5em;
      border-radius: 4px;
      color: #fff;
      margin: 0 2px;
    }
  </style>
</head>
<body>
  <div class="header">Sparrows Volleyball Schedule</div>
  <div class="description">Ver 1.021</div>

  <div class="filters">
    <select id="teamFilter"><option value="">Select Team</option></select>
    <select id="divisionFilter"><option value="">Select Division</option></select>
    <select id="courtFilter"><option value="">Select Court</option></select>
    <select id="dateFilter"><option value="">Select Date</option></select>
    <button onclick="resetFilters()">Reset</button>
  </div>

  <div id="matchContainer"></div>

  <div id="popupContainer"></div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbz9xgbl0i1QGLhYmZ_blhCxZvZLlhwAD4c75bhItaYCXi3U5HV5Vo7JK9zlEz9dKms/exec";
    let matchData = {};
    let defaultDate = "";

    function teamColor(team) {
      let colors = {
        "Team A": "#E74C3C", "Team B": "#2980B9", "Team C": "#27AE60",
        "Team D": "#8E44AD", "Team E": "#F39C12", "Team F": "#16A085"
      };
      return colors[team] || "#2C3E50";
    }

    function fetchData() {
      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          matchData = data.schedule;
          defaultDate = data.defaultDate;
          populateFilters(matchData);
          renderMatches(matchData);
        });
    }

    function populateFilters(data) {
      const teamSet = new Set(), divisionSet = new Set(), courtSet = new Set(), dateSet = [];

      for (let date in data) {
        dateSet.push(date);
        data[date].forEach(m => {
          teamSet.add(m.team);
          teamSet.add(m.opponent);
          divisionSet.add(m.division);
          courtSet.add(m.location);
        });
      }

      dateSet.sort((a, b) => Object.keys(data).indexOf(a) - Object.keys(data).indexOf(b));

      const teamSel = document.getElementById("teamFilter");
      const divSel = document.getElementById("divisionFilter");
      const courtSel = document.getElementById("courtFilter");
      const dateSel = document.getElementById("dateFilter");

      [teamSel, divSel, courtSel, dateSel].forEach(sel => sel.innerHTML = '<option value="">All</option>');

      [...teamSet].forEach(t => teamSel.innerHTML += `<option value="${t}">${t}</option>`);
      [...divisionSet].forEach(d => divSel.innerHTML += `<option value="${d}">${d}</option>`);
      [...courtSet].forEach(c => courtSel.innerHTML += `<option value="${c}">${c}</option>`);
      dateSet.forEach(d => dateSel.innerHTML += `<option value="${d}">${d}</option>`);

      dateSel.value = defaultDate;
      filterMatches();
    }

    function resetFilters() {
      ["teamFilter", "divisionFilter", "courtFilter", "dateFilter"].forEach(id => {
        document.getElementById(id).value = "";
      });
      location.reload();
    }

    function filterMatches() {
      const team = document.getElementById("teamFilter").value;
      const div = document.getElementById("divisionFilter").value;
      const court = document.getElementById("courtFilter").value;
      const date = document.getElementById("dateFilter").value;

      const filtered = {};
      for (let d in matchData) {
        if (date && d !== date) continue;
        const matches = matchData[d].filter(m =>
          (!team || m.team === team || m.opponent === team || m.dutyTeam === team) &&
          (!div || m.division === div) &&
          (!court || m.location === court)
        );
        if (matches.length) filtered[d] = matches;
      }
      renderMatches(filtered);
    }

    function renderMatches(data) {
      const container = document.getElementById("matchContainer");
      container.innerHTML = "";

      for (let date in data) {
        data[date].forEach((match, i) => {
          const div = document.createElement("div");
          div.className = "match-card";
          const teamA = `<span class="team-color" style="background:${teamColor(match.team)}">${match.team}</span>`;
          const teamB = `<span class="team-color" style="background:${teamColor(match.opponent)}">${match.opponent}</span>`;
          div.innerHTML = `
            <div class="match-team">${teamA}<span class="match-vs"> vs </span>${teamB}</div>
            <div class="match-detail">Time: ${match.time}, Court: ${match.location}, Duty: ${match.dutyTeam}</div>
            ${match.allowResult ? `<button class="score-btn" id="btn-${date}-${i}" onclick="enterResult('${date}', ${i})">Enter Result (Referee use only)</button>` : ""}
          `;
          container.appendChild(div);
        });
      }
    }

    function enterResult(date, index) {
      const pass = prompt("Enter passcode:");
      if (!pass) return;
      fetch(`${apiUrl}?action=validate&date=${encodeURIComponent(date)}&index=${index}&passcode=${pass}`)
        .then(r => r.text())
        .then(t => {
          if (t === "PASS_OK") showScorePopup(date, index, pass);
          else alert("Passcode incorrect.");
        });
    }

    function showScorePopup(date, index, passcode) {
      const popup = document.createElement("div");
      popup.className = "popup";
      popup.innerHTML = `
        <h3>Enter Scores</h3>
        ${[1, 2, 3, 4, 5].map(i => `
          <label>${i} Set</label>
          <input type="number" id="a${i}" placeholder="Team A Score"/>
          <input type="number" id="b${i}" placeholder="Team B Score"/>
        `).join('')}
        <label>Comment</label>
        <input type="text" id="comment" maxlength="255" placeholder="Optional comment (max 255 chars)"/>
        <div style="font-size: 0.8em; color: #999;">*Max 255 characters</div>
        <button onclick="submitScores('${date}', ${index}, '${passcode}')">Submit</button>
      `;
      document.getElementById("popupContainer").appendChild(popup);
    }

    function submitScores(date, index, passcode) {
      const params = new URLSearchParams({
        action: "submitScores",
        date,
        index,
        passcode,
        a1: document.getElementById("a1").value,
        b1: document.getElementById("b1").value,
        a2: document.getElementById("a2").value,
        b2: document.getElementById("b2").value,
        a3: document.getElementById("a3").value,
        b3: document.getElementById("b3").value,
        a4: document.getElementById("a4").value,
        b4: document.getElementById("b4").value,
        a5: document.getElementById("a5").value,
        b5: document.getElementById("b5").value,
        comment: document.getElementById("comment").value
      });

      fetch(`${apiUrl}?${params}`)
        .then(r => r.text())
        .then(t => {
          if (t === "SUBMIT_OK") {
            alert("Result submitted successfully!");
            location.reload();
          } else {
            alert("Submission failed.");
          }
        });
    }

    document.querySelectorAll("select").forEach(sel => {
      sel.addEventListener("change", filterMatches);
    });

    window.onload = fetchData;
  </script>
</body>
</html>
