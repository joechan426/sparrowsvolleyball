<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volleyball Schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff;
      color: #333;
    }
    h1 {
      text-align: center;
      font-weight: 600;
    }
    h2 {
      margin-top: 40px;
    }
    select, button {
      margin: 0 10px 10px 0;
      padding: 6px 10px;
      font-size: 16px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 8px;
      margin: 10px 0;
      padding: 10px 15px;
      background-color: #f9f9f9;
    }
    .teams {
      font-size: 20px;
      font-weight: bold;
    }
    .info {
      margin-top: 5px;
    }
    #scorePopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
    }
    #scorePopup input[type="number"] {
      width: 60px;
      padding: 4px;
      margin: 4px;
    }
    #scorePopup h3 {
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Volleyball Weekly Schedule</h1>
  <p style="text-align:center;">Thank you so much for helping our league run smoothly</p>
  <div style="text-align:center; margin-bottom:20px;">
    <select id="teamFilter"><option value="">Select Team</option></select>
    <select id="divisionFilter"><option value="">Select Division</option></select>
    <select id="courtFilter"><option value="">Select Court</option></select>
    <select id="dateFilter"><option value="">Select Date</option></select>
    <button onclick="resetFilters()">Reset</button>
  </div>
  <div id="scheduleContainer"></div>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbySZw8bpjzQyQbh0HeMlpybUkauDSSqEIGBaqE5dePWTCWfvTftYAHFIJCwsJ7aUBs/exec";
    let fullData = {}, defaultDate = "";

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        fullData = data.schedule;
        defaultDate = data.defaultDate;
        populateFilters();
        applyFilters();
      });

    function populateFilters() {
      const teamSet = new Set(), divisionSet = new Set(), courtSet = new Set(), dateSet = [];

      for (const date in fullData) {
        if (!dateSet.includes(date)) dateSet.push(date);
        fullData[date].forEach((match) => {
          teamSet.add(match.team);
          teamSet.add(match.opponent);
          divisionSet.add(match.division);
          courtSet.add(match.location);
        });
      }

      const teamFilter = document.getElementById("teamFilter");
      [...teamSet].sort().forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        teamFilter.appendChild(opt);
      });

      const divisionFilter = document.getElementById("divisionFilter");
      [...divisionSet].sort().forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        divisionFilter.appendChild(opt);
      });

      const courtFilter = document.getElementById("courtFilter");
      [...courtSet].sort().forEach(c => {
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        courtFilter.appendChild(opt);
      });

      const dateFilter = document.getElementById("dateFilter");
      dateSet.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        if (d === defaultDate) opt.selected = true;
        dateFilter.appendChild(opt);
      });

      teamFilter.onchange = divisionFilter.onchange = courtFilter.onchange = dateFilter.onchange = applyFilters;
    }

    function applyFilters() {
      const team = document.getElementById("teamFilter").value;
      const division = document.getElementById("divisionFilter").value;
      const court = document.getElementById("courtFilter").value;
      const date = document.getElementById("dateFilter").value || defaultDate;

      const container = document.getElementById("scheduleContainer");
      container.innerHTML = "";

      if (!fullData[date]) return;

      fullData[date].forEach((match, index) => {
        if (
          (team && match.team !== team && match.opponent !== team && match.dutyTeam !== team) ||
          (division && match.division !== division) ||
          (court && match.location !== court)
        ) return;

        const card = document.createElement("div");
        card.className = "card";

        card.innerHTML = `
          <div class="teams">${match.team} vs ${match.opponent}</div>
          <div class="info">Time: ${match.time}</div>
          <div class="info">Court: ${match.location}</div>
          <div class="info">Duty Team: ${match.dutyTeam}</div>
        `;

        if (match.allowResult) {
          const btn = document.createElement("button");
          btn.textContent = "Enter Result (Referee use only)";
          btn.style.background = "#0071e3";
          btn.style.color = "#fff";
          btn.style.border = "none";
          btn.style.borderRadius = "6px";
          btn.style.padding = "6px 12px";
          btn.style.marginTop = "10px";
          btn.id = `btn-${date}-${index}`;
          btn.onclick = () => enterResult(match, index, date);
          card.appendChild(btn);
        }

        container.appendChild(card);
      });
    }

    function resetFilters() {
      document.getElementById("teamFilter").value = "";
      document.getElementById("divisionFilter").value = "";
      document.getElementById("courtFilter").value = "";
      document.getElementById("dateFilter").value = defaultDate;
      applyFilters();
    }

    function enterResult(match, index, date) {
      const pass = prompt("Enter passcode");
      if (!pass) return;

      fetch(`${apiUrl}?action=validate&date=${encodeURIComponent(date)}&index=${index}&passcode=${pass}`)
        .then(res => res.text())
        .then(result => {
          if (result.trim() === "PASS_OK") {
            showScoreInputPopup(match, index, date);
          } else {
            alert("Passcode Error");
          }
        });
    }

    function showScoreInputPopup(match, index, date) {
      const popup = document.createElement("div");
      popup.id = "scorePopup";
      popup.innerHTML = `
        <h3>${match.team} vs ${match.opponent}</h3>
        <table>
          <tr><th></th><th>${match.team}</th><th>${match.opponent}</th></tr>
          ${[1,2,3,4,5].map(i => `
            <tr>
              <td>${i} Set</td>
              <td><input type="number" inputmode="numeric"/></td>
              <td><input type="number" inputmode="numeric"/></td>
            </tr>`).join("")}
        </table>
        <br/>
        <button onclick="submitScores(${index}, '${date}')">Submit</button>
      `;
      document.body.appendChild(popup);
    }

    function submitScores(index, date) {
      const inputs = document.querySelectorAll("#scorePopup input[type='number']");
      const aScores = [...inputs].filter((_, i) => i % 2 === 0).map(input => input.value);
      const bScores = [...inputs].filter((_, i) => i % 2 === 1).map(input => input.value);

      const params = new URLSearchParams({
        action: "submitScores",
        date: date,
        index: index,
        a1: aScores[0], b1: bScores[0],
        a2: aScores[1], b2: bScores[1],
        a3: aScores[2], b3: bScores[2],
        a4: aScores[3], b4: bScores[3],
        a5: aScores[4], b5: bScores[4]
      });

      fetch(apiUrl + "?" + params.toString())
        .then(res => res.text())
        .then(result => {
          if (result.trim() === "SUBMIT_OK") {
            alert("Result submitted successfully!");
            document.getElementById("scorePopup").remove();
            document.querySelector(`#btn-${date}-${index}`)?.remove();
          } else {
            alert("Submission failed. Try again.");
          }
        })
        .catch(err => {
          console.error("Submission error:", err);
          alert("An error occurred. Please try again later.");
        });
    }
  </script>
</body>
</html>
