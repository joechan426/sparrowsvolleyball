<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sparrows Volleyball Schedule</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #fff;
      color: #333;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    p.description {
      text-align: center;
      font-size: 1rem;
      color: #666;
      margin-bottom: 1.5rem;
    }
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1rem;
    }
    .filters select, .filters button {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 1rem;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem auto;
      max-width: 600px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #111;
    }
    .highlight {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .result-btn {
      background-color: #007aff;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 0.5rem;
    }
    dialog {
      border: none;
      border-radius: 12px;
      padding: 1rem;
      max-width: 400px;
    }
    dialog input[type="number"] {
      width: 60px;
      padding: 0.3rem;
      font-size: 1rem;
      margin: 0.2rem;
    }
    .score-table {
      display: flex;
      justify-content: space-between;
    }
    .score-table > div {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .score-labels {
      text-align: left;
    }
  </style>
</head>
<body>
  <h1>Sparrows Volleyball Schedule</h1>
  <p class="description">Thank you so much for helping our league run smoothly</p>
  <div class="filters">
    <select id="teamFilter"><option value="">Select Team</option></select>
    <select id="divisionFilter"><option value="">Select Division</option></select>
    <select id="courtFilter"><option value="">Select Court</option></select>
    <select id="dateFilter"><option value="">Select Date</option></select>
    <button onclick="resetFilters()">Reset</button>
  </div>
  <div id="schedule"></div>

  <dialog id="scoreDialog">
    <form method="dialog">
      <h3 id="popupTitle"></h3>
      <div class="score-table">
        <div class="score-labels">
          <p>1st Set</p><p>2nd Set</p><p>3rd Set</p><p>4th Set</p><p>5th Set</p>
        </div>
        <div>
          <strong id="teamAName"></strong>
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreA1">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreA2">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreA3">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreA4">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreA5">
        </div>
        <div>
          <strong id="teamBName"></strong>
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreB1">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreB2">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreB3">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreB4">
          <input type="number" min="0" inputmode="numeric" class="scoreInput" id="scoreB5">
        </div>
      </div>
      <button id="submitScore" type="submit">Submit</button>
    </form>
  </dialog>

  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbwUAh9tYZbnO9Fz-tqKxWhaupPNSZv0i2g5boib2tu8i0szhjD4UMiYqNjOYlNUNCk/exec";
    let allData = {};
    let currentMatch = {};

    async function fetchData() {
      const res = await fetch(apiUrl);
      const data = await res.json();
      allData = data;
      populateFilters();
      render();
    }

    function populateFilters() {
      const teams = new Set();
      const divisions = new Set();
      const courts = new Set();
      const dates = Object.keys(allData).filter(k => !k.startsWith("_"));
      dates.forEach(date => {
        allData[date].forEach(match => {
          teams.add(match.team);
          teams.add(match.opponent);
          divisions.add(match.division);
          courts.add(match.location);
        });
      });
      setOptions("teamFilter", [...teams].sort());
      setOptions("divisionFilter", [...divisions].sort());
      setOptions("courtFilter", [...courts].sort());
      setOptions("dateFilter", dates);
      document.getElementById("dateFilter").value = allData._defaultDate || "";
    }

    function setOptions(id, values) {
      const select = document.getElementById(id);
      values.forEach(v => {
        const option = document.createElement("option");
        option.value = v;
        option.textContent = v;
        select.appendChild(option);
      });
    }

    function resetFilters() {
      ["teamFilter", "divisionFilter", "courtFilter", "dateFilter"].forEach(id => {
        document.getElementById(id).value = "";
      });
      render();
    }

    function render() {
      const team = document.getElementById("teamFilter").value;
      const division = document.getElementById("divisionFilter").value;
      const court = document.getElementById("courtFilter").value;
      const date = document.getElementById("dateFilter").value;
      const container = document.getElementById("schedule");
      container.innerHTML = "";

      Object.keys(allData).forEach(dateKey => {
        if (date && dateKey !== date) return;
        allData[dateKey].forEach((match, index) => {
          const matchTeam = match.team;
          const matchOpponent = match.opponent;
          if (
            (team && matchTeam !== team && matchOpponent !== team) ||
            (division && match.division !== division) ||
            (court && match.location !== court)
          ) return;

          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h2><span class="highlight">${match.team}</span> vs <span class="highlight">${match.opponent}</span></h2>
            <p><strong>Time:</strong> ${match.time}</p>
            <p><strong>Court:</strong> ${match.location}</p>
            <p><strong>Division:</strong> ${match.division}</p>
            <p><strong>Duty Team:</strong> ${match.dutyTeam}</p>
          `;
          if (match.allowSubmit) {
            const btn = document.createElement("button");
            btn.className = "result-btn";
            btn.textContent = "Enter Result (Referee use only)";
            btn.onclick = async () => {
              const pass = prompt("Enter Passcode");
              if (!pass) return;
              const checkUrl = `${apiUrl}?action=validate&date=${encodeURIComponent(dateKey)}&index=${index}&passcode=${encodeURIComponent(pass)}`;
              const resp = await fetch(checkUrl);
              const result = await resp.text();
              if (result.trim() === "PASS_OK") {
                currentMatch = { date: dateKey, index, team: match.team, opponent: match.opponent };
                document.getElementById("popupTitle").textContent = `${match.team} vs ${match.opponent}`;
                document.getElementById("teamAName").textContent = match.team;
                document.getElementById("teamBName").textContent = match.opponent;
                document.querySelectorAll(".scoreInput").forEach(el => el.value = "");
                document.getElementById("scoreDialog").showModal();
              } else {
                alert("❌ Passcode Error");
              }
            };
            card.appendChild(btn);
          }
          container.appendChild(card);
        });
      });
    }

    document.getElementById("submitScore").onclick = async () => {
      const payload = {
        action: "submit",
        date: currentMatch.date,
        index: currentMatch.index,
        scores: [1,2,3,4,5].map(i => [
          document.getElementById(`scoreA${i}`).value || "",
          document.getElementById(`scoreB${i}`).value || ""
        ])
      };
      await fetch(apiUrl + "?action=submit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      document.getElementById("scoreDialog").close();
      alert("✅ Score submitted!");
      fetchData();
    };

    ["teamFilter", "divisionFilter", "courtFilter", "dateFilter"].forEach(id => {
      document.getElementById(id).addEventListener("change", render);
    });

    fetchData();
  </script>
</body>
</html>
